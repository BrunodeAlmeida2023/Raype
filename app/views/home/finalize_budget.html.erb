<% content_for :body_class, "orange-bg" %>

<header class="home-header">
  <div class="home-header-left">
    <div class="home-header-logo">
      <img src="/Logo.png" alt="Raype Logo" class="header-logo-img">
    </div>
    <h1>RAYPE</h1>
  </div>
  <nav class="home-nav">
    <%= link_to "Voltar", root_path, class: "home-nav-btn" %>
  </nav>
</header>

<%= form_with url: post_finalize_budget_home_path, method: :post, class: "home-form-container", id: "finalize-budget-form", data: { turbo: false} do |f| %>
  <div class="budget-container">
    <h1 class="home-services-title">Resumo do Orçamento</h1>

    <%
      # ✅ SEGURO: Dados calculados via helper
      data = safe_budget_data(@outdoor)
      budget = data[:budget]
    %>

    <div class="budget-layout">
      <!-- Lado Esquerdo: Detalhes -->
      <div class="budget-details">
        <!-- Card: Outdoor -->
        <div class="budget-card">
          <div class="budget-card-header">
            <i class="fas fa-rectangle-ad budget-card-icon"></i>
            <h3>Outdoor Selecionado</h3>
          </div>
          <div class="budget-card-body">
            <div class="budget-info-row">
              <span class="budget-label">Tipo:</span>
              <span class="budget-value"><%= data[:outdoor_type] %></span>
            </div>
            <div class="budget-info-row">
              <span class="budget-label">Tamanho:</span>
              <span class="budget-value"><%= data[:outdoor_size] %></span>
            </div>
            <div class="budget-info-row">
              <span class="budget-label">Local:</span>
              <span class="budget-value"><%= data[:outdoor_location] %></span>
            </div>
          </div>
        </div>

        <!-- Card: Período -->
        <div class="budget-card">
          <div class="budget-card-header">
            <i class="fas fa-calendar-days budget-card-icon"></i>
            <h3>Período de Veiculação</h3>
          </div>
          <div class="budget-card-body">
            <div class="budget-info-row">
              <span class="budget-label">Data Inicial:</span>
              <span class="budget-value"><%= format_budget_date(data[:start_date]) %></span>
            </div>
            <div class="budget-info-row">
              <span class="budget-label">Data Final:</span>
              <span class="budget-value"><%= format_budget_date(data[:end_date]) %></span>
            </div>
            <div class="budget-info-row">
              <span class="budget-label">Duração:</span>
              <span class="budget-value highlight"><%= data[:months] %> <%= pluralize_months(data[:months]) %></span>
            </div>
          </div>
        </div>

        <!-- Card: Artes Gráficas -->
        <div class="budget-card">
          <div class="budget-card-header">
            <i class="fas fa-palette budget-card-icon"></i>
            <h3>Artes Gráficas</h3>
          </div>
          <div class="budget-card-body">
            <div class="budget-info-row">
              <span class="budget-label">Quantidade de Artes:</span>
              <span class="budget-value"><%= data[:art_quantity] %> <%= pluralize_arts(data[:art_quantity]) %></span>
            </div>
            <% if data[:art_quantity] > 0 %>
              <div class="budget-info-row">
                <span class="budget-label">Valor por Arte:</span>
                <span class="budget-value">R$ <%= format_budget_value(budget[:art_price_per_unit]) %>,00</span>
              </div>
              <div class="budget-arts-preview">
                <% @outdoor.art_files.each_with_index do |art, index| %>
                  <div class="budget-art-thumb">
                    <%= image_tag art, alt: "Arte #{index + 1}" %>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="budget-info-note">
                <i class="fas fa-info-circle"></i>
                <p>Artes serão criadas pela nossa equipe de design</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Lado Direito: Totais -->
      <div class="budget-summary">
        <div class="budget-summary-card">
          <h3 class="budget-summary-title">Valores</h3>

          <div class="budget-summary-items">
            <!-- Aluguel Mensal -->
            <div class="budget-summary-item">
              <div class="budget-summary-item-header">
                <span class="budget-summary-label">Aluguel (<%= budget[:months] %> <%= pluralize_months(budget[:months]) %>)</span>
                <span class="budget-summary-calc"><%= budget[:months] %> × R$ <%= format_budget_value(budget[:monthly_price]) %></span>
              </div>
              <div class="budget-summary-value">
                R$ <%= format_budget_value(budget[:rental_total]) %>,00
              </div>
            </div>

            <!-- Artes Gráficas -->
            <div class="budget-summary-item">
              <div class="budget-summary-item-header">
                <span class="budget-summary-label">Artes (<%= budget[:art_count] %> <%= pluralize_arts(budget[:art_count]) %>)</span>
                <span class="budget-summary-calc"><%= budget[:art_count] %> × R$ <%= format_budget_value(budget[:art_price_per_unit]) %></span>
              </div>
              <div class="budget-summary-value">
                R$ <%= format_budget_value(budget[:art_total]) %>,00
              </div>
            </div>

            <!-- Taxa de Instalação -->
            <div class="budget-summary-item">
              <div class="budget-summary-item-header">
                <span class="budget-summary-label">Instalação</span>
              </div>
              <div class="budget-summary-value">
                R$ <%= format_budget_value(budget[:installation_fee]) %>,00
              </div>
            </div>

            <!-- Taxa de Design (se aplicável) -->
            <% if budget[:design_fee] > 0 %>
              <div class="budget-summary-item">
                <div class="budget-summary-item-header">
                  <span class="budget-summary-label">Design</span>
                </div>
                <div class="budget-summary-value">
                  R$ <%= format_budget_value(budget[:design_fee]) %>,00
                </div>
              </div>
            <% end %>
          </div>

          <div class="budget-summary-divider"></div>

          <!-- Total Geral -->
          <div class="budget-summary-total">
            <span class="budget-summary-total-label">Total</span>
            <span class="budget-summary-total-value">
              R$ <%= format_budget_value(budget[:total]) %>,00
            </span>
          </div>

          <%= hidden_field_tag :outdoor_id, @outdoor.id %>

          <!-- Nota sobre disponibilidade -->
          <div class="budget-summary-note budget-availability-note">
            <i class="fas fa-info-circle"></i>
            <p>
              <strong>Importante:</strong> Ao confirmar o pagamento, estas datas ficarão reservadas.
              Caso o outdoor já esteja alugado no período selecionado, você será notificado.
            </p>
          </div>

          <!-- Botão de Pagamento -->
          <div class="budget-summary-actions">
            <%= f.submit "Pagar Agora", class: "budget-pay-btn" %>
          </div>

          <!-- Info adicional -->
          <div class="budget-summary-note">
            <i class="fas fa-shield-halved"></i>
            <p>Pagamento 100% seguro</p>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
